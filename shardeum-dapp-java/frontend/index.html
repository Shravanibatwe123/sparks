<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Shardeum DApp</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
    body {
      background: linear-gradient(-45deg, #10b981, #3b82f6, #f59e0b, #ef4444);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      color: #333;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      25% { background-position: 50% 100%; }
      50% { background-position: 100% 50%; }
      75% { background-position: 50% 0%; }
      100% { background-position: 0% 50%; }
    }
    h1,h2,h3 { color: #111; }
    nav { background: rgba(31, 41, 55, 0.9); padding: 15px 30px; display: flex; gap: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); backdrop-filter: blur(5px); }
    nav a { color: #fff; text-decoration: none; font-weight: 600; transition: color 0.3s; }
    nav a:hover { color: #10b981; }
    .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
    h1 { font-size: 32px; margin-bottom: 20px; }
    .section-title { font-size: 24px; margin: 30px 0 10px; }
    button { padding: 12px 25px; border: none; border-radius: 12px; background: linear-gradient(90deg, #10b981, #3b82f6); color: #fff; font-weight: 600; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; }
    button:hover { transform: scale(1.05); box-shadow: 0 6px 15px rgba(0,0,0,0.2); }
    .grid { display: grid; gap: 20px; margin-top: 20px; }
    .grid-4 { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .card { background: rgba(255,255,255,0.9); border-radius: 16px; padding: 25px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); transform: translateY(30px); opacity: 0; transition: transform 0.5s ease, opacity 0.5s ease, box-shadow 0.3s; }
    .card.visible { transform: translateY(0); opacity: 1; }
    .card:hover { box-shadow: 0 12px 25px rgba(0,0,0,0.15); }
    .card-title { font-size: 16px; color: #6b7280; }
    .card-value { font-size: 28px; font-weight: 700; margin-top: 8px; color: #111827; }
    #bookingModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000; opacity:0; transition: opacity 0.3s ease; }
    #bookingModal.show { display:flex; opacity:1; }
    #bookingModal div { background:#fff; padding:30px; border-radius:12px; width:90%; max-width:400px; position:relative; transform: translateY(-30px); transition: transform 0.3s ease; }
    #bookingModal.show div { transform: translateY(0); }
    #bookingModal input { width:100%; padding:10px; margin:10px 0; border-radius:8px; border:1px solid #ccc; }
    #closeModal { position:absolute; top:10px; right:15px; cursor:pointer; font-size:20px; }
    @media (max-width:768px){ .grid-4{ grid-template-columns:1fr 1fr; } }
    @media (max-width:480px){ .grid-4{ grid-template-columns:1fr; } nav{ flex-direction:column; gap:10px; } }
  </style>
</head>
<body>

<nav>
  <a href="attendance.html">Attendance</a>
  <a href="voting.html">Voting</a>
  <a href="certificates.html">Certificates</a>
  <a href="booking.html">Booking</a>
</nav>

<div class="container">
  <h1>Welcome to Shardeum DApp</h1>
  <p style="color:#6b7280; font-weight:700; font-size:18px;">
    Make sure MetaMask is configured to Shardeum Unstablenet (RPC: <code>https://api-unstable.shardeum.org</code>, chainId: <code>8080</code>).
  </p>

  <button onclick="connectWallet()">Connect Wallet</button>
  <p id="walletStatus" style="color:#fff; font-weight:bold;"></p>

  <button onclick="markAttendance()">Mark Attendance</button>
  <button id="newBookingBtn">+ New Booking</button>

  <h2 class="section-title">Dashboard Stats</h2>
  <div class="grid grid-4">
    <div class="card"><p class="card-title">Available Resources</p><p class="card-value" id="available-resources">0</p></div>
    <div class="card"><p class="card-title">My Bookings</p><p class="card-value" id="my-bookings">0</p></div>
    <div class="card"><p class="card-title">Today's Bookings</p><p class="card-value" id="today-bookings">0</p></div>
    <div class="card"><p class="card-title">Attendance Marked</p><p class="card-value" id="total-attendance">0</p></div>
    <div class="card"><p class="card-title">Total Usage</p><p class="card-value" id="total-usage">0</p></div>
  </div>
</div>

<div id="bookingModal">
  <div>
    <h2 style="margin-bottom:20px;">New Booking</h2>
    <label>Resource Name</label>
    <input type="text" id="resourceName" placeholder="Enter resource name">
    <label>Booking Date & Time</label>
    <input type="datetime-local" id="bookingTime">
    <button id="submitBooking">Book Now</button>
    <span id="closeModal">&times;</span>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
async function connectWallet() {
  if (typeof window.ethereum === "undefined") {
    alert("MetaMask is not installed. Please install it to use this DApp.");
    return;
  }

  // Create provider
  const provider = new ethers.providers.Web3Provider(window.ethereum);

  try {
    // Request wallet connection
    await provider.send("eth_requestAccounts", []);

    const signer = provider.getSigner();
    const walletAddress = await signer.getAddress();

    console.log("✅ Connected Wallet:", walletAddress);
    alert("Wallet Connected: " +0xf9788d25F278Cb98f69Afbcb2B03252e29448c26 );

    // Optionally show address on screen
    document.getElementById("walletStatus").textContent =
      "Connected: " + walletAddress.slice(0, 6) + "..." + walletAddress.slice(-4);
  } catch (err) {
    console.error("❌ Wallet connection failed:", err);
    alert("Failed to connect wallet. Please try again.");
  }
}
</script>

<script>
let resources = [
  { id: 1, status: "active" },
  { id: 2, status: "inactive" },
  { id: 3, status: "active" }
];

let bookings = [
  { id: 1, user_email: "test@shardeum.org", start_time: new Date().toISOString() },
  { id: 2, user_email: "other@shardeum.org", start_time: new Date().toISOString() },
  { id: 3, user_email: "test@shardeum.org", start_time: "2024-01-01T10:00:00" }
];

let attendance = [
  { id: 1, user_email: "test@shardeum.org", date: new Date().toDateString() },
  { id: 2, user_email: "other@shardeum.org", date: new Date().toDateString() }
];

const user = { email: "test@shardeum.org", full_name: "John Doe" };

/* Blockchain Integration */
let provider, signer;
let attendanceContract;

// Your attendance contract address
const ATTENDANCE_ADDRESS = "0xf9788d25F278Cb98f69Afbcb2B03252e29448c26";

// Minimal ABI for markAttendance function
const ATTENDANCE_ABI = [
  {
    "inputs": [],
    "name": "markAttendance",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  }
];


async function connectWallet() {
  if (!window.ethereum) { alert("MetaMask not installed!"); return; }
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  attendanceContract = new ethers.Contract(ATTENDANCE_ADDRESS, ATTENDANCE_ABI, signer);
  const addr = await signer.getAddress();
  alert("Wallet connected: " + addr);
}

async function markAttendance() {
  if (!attendanceContract) { alert("Connect wallet first!"); return; }
  try {
    const tx = await attendanceContract.markAttendance();
    await tx.wait();
    alert("Attendance marked on blockchain!");
    attendance.push({ id: attendance.length + 1, user_email: user.email, date: new Date().toDateString() });
    updateDashboard();
  } catch (e) { console.error(e); alert("Failed to mark attendance"); }
}

/* Dashboard animation */
function animateValue(id, start, end, duration) {
  let obj = document.getElementById(id);
  let range = end - start;
  let startTime = null;
  function step(timestamp) {
    if (!startTime) startTime = timestamp;
    let progress = Math.min((timestamp - startTime) / duration, 1);
    obj.textContent = Math.floor(progress * range + start);
    if (progress < 1) window.requestAnimationFrame(step);
  }
  window.requestAnimationFrame(step);
}

function updateDashboard() {
  const availableResources = resources.filter(r => r.status === 'active').length;
  const userBookings = bookings.filter(b => b.user_email === user.email);
  const today = new Date().toDateString();
  const todayBookings = bookings.filter(b => new Date(b.start_time).toDateString() === today);

  animateValue("available-resources", 0, availableResources, 600);
  animateValue("my-bookings", 0, userBookings.length, 600);
  animateValue("today-bookings", 0, todayBookings.length, 600);
  animateValue("total-attendance", 0, attendance.length, 600);
  animateValue("total-usage", 0, bookings.length + attendance.length, 600);

  document.querySelectorAll('.card').forEach((card, index) => {
    setTimeout(() => card.classList.add('visible'), index * 100);
  });
}

updateDashboard();

/* Booking Modal Logic */
const newBookingBtn = document.getElementById('newBookingBtn');
const bookingModal = document.getElementById('bookingModal');
const closeModal = document.getElementById('closeModal');
const submitBooking = document.getElementById('submitBooking');

newBookingBtn.onclick = () => bookingModal.classList.add('show');
closeModal.onclick = () => bookingModal.classList.remove('show');

submitBooking.onclick = () => {
  const resource = document.getElementById('resourceName').value;
  const time = document.getElementById('bookingTime').value;

  if(!resource || !time){ alert("Please fill all fields!"); return; }

  bookings.push({ id: bookings.length + 1, user_email: user.email, start_time: time });
  alert("Booking successful!");
  bookingModal.classList.remove('show');
  document.getElementById('resourceName').value = '';
  document.getElementById('bookingTime').value = '';

  updateDashboard();
};
</script>

</body>
</html>
